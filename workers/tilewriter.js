(()=>{"use strict";var e={n:t=>{var s=t&&t.__esModule?()=>t.default:()=>t;return e.d(s,{a:s}),s},d:(t,s)=>{for(var r in s)e.o(s,r)&&!e.o(t,r)&&Object.defineProperty(t,r,{enumerable:!0,get:s[r]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};const t=require("worker_threads"),s=require("fs");var r=e.n(s);const n=require("redis"),o=require("path");var i=e.n(o);process.env.PORT,process.env.HOST,parseInt(process.env.USE_MAILER,10),process.env.MAIL_ADDRESS;const a=process.env.TILE_FOLDER||"tiles",{PROXYCHECK_KEY:c}=(i().join(__dirname,`./${a}`),process.env.USE_XREALIP,process.env.BACKUP_URL,process.env.BACKUP_DIR,process.env.OUTGOING_ADDRESS,parseInt(process.env.USE_PROXYCHECK,10),process.env),l=process.env.REDIS_URL||"redis://localhost:6379",h=process.env.SHARD_NAME||null,u=(process.env.MYSQL_HOST,process.env.MYSQL_DATABASE,process.env.MYSQL_USER,process.env.MYSQL_PW,process.env.GUILDED_INVITE,parseInt(process.env.LOG_MYSQL,10),parseInt(process.env.HOURLY_EVENT,10),process.env.APISOCKET_KEY,process.env.ADMIN_IDS&&process.env.ADMIN_IDS.split(",").map((e=>parseInt(e,10))),process.env.CORS_HOSTS&&process.env.CORS_HOSTS.split(","),process.env.FACEBOOK_APP_ID,process.env.FACEBOOK_APP_SECRET,process.env.DISCORD_CLIENT_ID,process.env.DISCORD_CLIENT_SECRET,process.env.GOOGLE_CLIENT_ID,process.env.GOOGLE_CLIENT_SECRET,process.env.VK_CLIENT_ID,process.env.VK_CLIENT_SECRET,process.env.REDDIT_CLIENT_ID,process.env.REDDIT_CLIENT_SECRET,parseInt(process.env.CAPTCHA_TIME,10),parseInt(process.env.CAPTCHA_TIMEOUT,10),process.env.SESSION_SECRET,{placePxl:(0,n.defineScript)({NUMBER_OF_KEYS:9,SCRIPT:r().readFileSync("./workers/lua/placePixel.lua"),transformArguments:(...e)=>e.map((e=>"string"==typeof e?e:e.toString())),transformReply:e=>e.map((e=>Number(e)))}),allowedChat:(0,n.defineScript)({NUMBER_OF_KEYS:3,SCRIPT:r().readFileSync("./workers/lua/allowedChat.lua"),transformArguments:(...e)=>e.map((e=>"string"==typeof e?e:e.toString())),transformReply:e=>e.map((e=>Number(e)))}),getUserRanks:(0,n.defineScript)({NUMBER_OF_KEYS:2,SCRIPT:r().readFileSync("./workers/lua/getUserRanks.lua"),transformArguments:(...e)=>e.map((e=>"string"==typeof e?e:e.toString())),transformReply:e=>e.map((e=>Number(e)))}),zmRankRev:(0,n.defineScript)({NUMBER_OF_KEYS:1,SCRIPT:r().readFileSync("./workers/lua/zmRankRev.lua"),transformArguments:(e,t)=>[e,...t.map((e=>"string"==typeof e?e:e.toString()))],transformReply:e=>e.map((e=>Number(e)||null))})}),f=(0,n.createClient)(l.startsWith("redis://")?{url:l,scripts:u}:{socket:{path:l},scripts:u}),d={subscriber:null,publisher:null},p=f,g=require("sharp");var m=e.n(g);const w=256;function $(e,t){return(e%t+t)%t}function b(e){return e?Math.log2(e/w)/2*2:0}function C(e,t){if(!t)return e;if(!e)return t;if(Array.isArray(e))return e.concat(t);if("object"==typeof e){const s=Object.keys(e);return s.includes("columns")?function(e,t){let s;if(e.columns.length===t.columns.length)e.rows=e.rows.concat(t.rows),s=e;else{let r;if(e.columns.length<t.columns.length?(s=t,r=e):(s=e,r=t),!r.rows.length)return s;const n=[];for(let e=0;e<r.rows.length;e+=1)n.push([]);for(let e=0;e<s.columns.length;e+=1){const t=r.columns.indexOf(s.columns[e]);if(~t)for(let e=0;e<r.rows.length;e+=1)n[e].push(r.rows[e][t]);else for(let e=0;e<r.rows.length;e+=1)n[e].push(null)}s.rows=s.rows.concat(n)}"rid"===s.columns[0]&&s.rows.forEach(((e,t)=>{e[0]=t}));const r=s.columns.indexOf("#");if(~r){let e=s.columns.indexOf("canvas");if(-1===e&&(e=s.columns.indexOf("IID")),~e){const t=s.columns.indexOf("time");for(let n=0;n<s.rows.length;n+=1){const o=s.rows[n],i=o[e];if(i&&"N/A"!==i)for(let a=n+1;a<s.rows.length;a+=1){const c=s.rows[a];if(c[e]===i){const e=o[r]+c[r];~t&&o[t]<c[t]&&(s.rows[n]=c),s.rows.splice(a,1),s.rows[n][r]=e,a-=1}}}}}return s}(e,t):(s.forEach((s=>{const r=e[s],n=t[s];e[s]=C(r,n)})),e)}return e+t}const S=require("events");var E=e.n(S);function T(e,t,s){const r=new Uint8Array([193,e,t]);return Buffer.concat([r,s])}class y extends(E()){constructor(){super(),this.onlineCounter={total:0}}async initialize(){}getLowestActiveShard(){return null}amIImportant(){return!0}onAsync(e,t){this.on(e,((...e)=>{setImmediate((()=>{t(...e)}))}))}req(e,...t){return new Promise(((s,r)=>{const n=Math.floor(1e5*Math.random()).toString()+Math.floor(1e5*Math.random()).toString(),o=`res:${n}`;let i;const a=e=>{clearTimeout(i),s(e)};i=setTimeout((()=>{this.off(o,a),r(new Error(`Timeout on req ${e}`))}),45e3),this.once(o,a),this.emit(`req:${e}`,n,...t)}))}res(e,t){this.emit(`res:${e}`,t)}onReq(e,t){this.on(`req:${e}`,(async(e,...s)=>{const r=await t(...s);this.res(e,r)}))}broadcastPixels(e,t,s){const r=t>>8,n=255&t,o=T(r,n,s);this.emit("pixelUpdate",e,t,o),this.emit("chunkUpdate",e,[r,n])}broadcastChunkUpdate(e,t){this.emit("chunkUpdate",e,t)}sendMail(...e){this.emit("mail",...e)}recvChatMessage(e,t,s){this.emit("recvChatMessage",e,t,s)}setCoolDownFactor(e){this.emit("setCoolDownFactor",e)}broadcastChatMessage(e,t,s,r,n="xx",o=!0){this.emit("chatMessage",e,t,s,r,n||"xx",o)}broadcastSUChatMessage(e,t,s,r,n,o="xx"){this.emit("suChatMessage",e,t,s,r,n,o||"xx")}broadcastAddChatChannel(e,t,s){this.emit("addChatChannel",e,t,s)}broadcastRemoveChatChannel(e,t){this.emit("remChatChannel",e,t)}broadcastRateLimitTrigger(e,t){this.emit("rateLimitTrigger",e,t)}rankingListUpdate(e){this.emit("rankingListUpdate",e)}reloadUser(e){this.emit("reloadUser",e)}broadcastOnlineCounter(e){this.onlineCounter=e,this.emit("onlineCounter",e)}}const I=y,v="bc",O=h?new class extends I{constructor(){super(),this.isCluster=!0,this.thisShard=h,this.csReq=[],this.shards={},this.shardOnlineCounters=[],this.publisher={publish:()=>{}},this.subscriber={subscribe:()=>{},unsubscribe:()=>{}},this.checkHealth=this.checkHealth.bind(this),setInterval(this.checkHealth,1e4)}async initialize(){this.publisher=d.publisher,this.subscriber=d.subscriber,await this.subscriber.subscribe(v,((...e)=>{this.onShardBCMessage(...e)})),await this.subscriber.subscribe(`l:${this.thisShard}`,((...e)=>{this.onShardListenMessage(...e)})),await new Promise((e=>{setTimeout(e,25e3)})),console.log("CLUSTER: Initialized message broker")}async onShardBCMessage(e){try{if(!e||e.startsWith(this.thisShard))return;const t=e.indexOf(",");if(~t){const s=e.slice(e.indexOf(":")+1,t);console.log("CLUSTER: Broadcast",s);const r=JSON.parse(e.slice(t+1));if(s.startsWith("req:")){const t=e.slice(0,e.indexOf(":")),s=r[0];this.csReq.push({id:s,shard:t,ts:Date.now()})}return void super.emit(s,...r)}if(!this.shards[e])return console.log(`CLUSTER: Shard ${e} connected`),this.shards[e]=Date.now(),await this.subscriber.subscribe(e,(t=>this.onShardBinaryMessage(t,e)),!0),void this.publisher.publish(v,this.thisShard);this.shards[e]=Date.now()}catch(e){console.error(`CLUSTER: Error on broadcast message: ${e.message}`)}}async onShardListenMessage(e){try{const t=e.indexOf(","),s=e.slice(0,t);console.log(`CLUSTER shard listener got ${s}`);const r=JSON.parse(e.slice(t+1));super.emit(s,...r)}catch(e){console.error(`CLUSTER: Error on listener message: ${e.message}`)}}getLowestActiveShard(){let e=0,t=null;return this.shardOnlineCounters.forEach((s=>{const[r,n]=s;(n.total<e||!t)&&(t=r,e=n.total)})),t||this.thisShard}amIImportant(){return!this.shardOnlineCounters[0]||this.shardOnlineCounters[0][0]===this.thisShard}req(e,...t){return new Promise(((s,r)=>{const n=Math.floor(1e5*Math.random()).toString()+Math.floor(1e5*Math.random()).toString(),o=`res:${n}`;let i,a=this.shardOnlineCounters.length,c=null;const l=t=>{a-=1,c=C(c,t),a<=0?(console.log(`CLUSTER res:${n}:${e} finished`),this.off(o,l),clearTimeout(i),s(c)):console.log(`CLUSTER got res:${n}:${e} from shard, ${a} still left`)};i=setTimeout((()=>{this.off(o,l),c?s(c):r(new Error(`CLUSTER Timeout on wait for res:${n}:${e}`))}),45e3),this.on(o,l),this.emit(`req:${e}`,n,...t)}))}res(e,t){const s=this.csReq.find((t=>t.id===e));console.log(`CLUSTER send res:${e} to shard ${s&&s.shard}`),s?(this.publisher.publish(`l:${s.shard}`,`res:${e},${JSON.stringify([t])}`),this.csReq=this.csReq.filter((t=>t.id!==e))):super.emit(`res:${e}`,t)}updateShardOnlineCounter(e,t){const s=this.shardOnlineCounters.find((t=>t[0]===e));s?s[1]=t:(this.shardOnlineCounters.push([e,t]),this.shardOnlineCounters.sort(((e,t)=>e[0].localeCompare(t[0])))),this.sumOnlineCounters()}onShardBinaryMessage(e,t){try{switch(e[0]){case 197:{const t=function(e){const t=e[1];return e.writeUInt8(193,1),[t,e.readUInt16BE(2),Buffer.from(e.buffer,e.byteOffset+1,e.length-1)]}(e);super.emit("pixelUpdate",...t);const s=t[1],r=[s>>8,255&s];super.emit("chunkUpdate",t[0],r);break}case 196:super.emit("chunkUpdate",...(s=e,[s[1],[s.readUInt8(2),s.readUInt8(3)]]));break;case 167:{const s=function(e){const t={};t.total=e.readUInt16BE(1);let s=e.length;for(;s>3;){const r=e.readUInt16BE(s-=2);t[e.readUInt8(s-=1)]=r}return t}(e);this.updateShardOnlineCounter(t,s);break}}}catch(e){console.error(`CLUSTER: Error on binary message of shard ${t}: ${e.message}`)}var s}sumOnlineCounters(){const e={};this.shardOnlineCounters.forEach((t=>{const[,s]=t;Object.keys(s).forEach((t=>{const r=s[t];e[t]?e[t]+=r:e[t]=r}))})),this.onlineCounter=e}emit(e,...t){super.emit(e,...t);const s=`${this.thisShard}:${e},${JSON.stringify(t)}`;this.publisher.publish(v,s)}broadcastPixels(e,t,s){const r=t>>8,n=255&t;this.publisher.publish(this.thisShard,function(e,t,s,r){const n=new Uint8Array([197,e,t,s]);return Buffer.concat([n,r])}(e,r,n,s));const o=T(r,n,s);super.emit("pixelUpdate",e,t,o),super.emit("chunkUpdate",e,[r,n])}setCoolDownFactor(e){this.amIImportant()?this.emit("setCoolDownFactor",e):super.emit("setCoolDownFactor",e)}recvChatMessage(e,t,s){super.emit("recvChatMessage",e,t,s)}broadcastChunkUpdate(e,t){this.publisher.publish(this.thisShard,function(e,[t,s]){return Buffer.from([196,e,t,s])}(e,t)),super.emit("chunkUpdate",e,t)}broadcastOnlineCounter(e){this.updateShardOnlineCounter(this.thisShard,e);const t=function(e){const t=Object.keys(e).filter((e=>"total"!==e)),s=Buffer.allocUnsafe(3+3*t.length);s.writeUInt8(167,0),s.writeUInt16BE(e.total,1);let r=1;for(let n=0;n<t.length;n+=1){const o=t[n],i=e[o];s.writeUInt8(Number(o),r+=2),s.writeUInt16BE(i,r+=1)}return s}(e);this.publisher.publish(this.thisShard,t),super.emit("onlineCounter",this.onlineCounter)}checkHealth(){let e=Date.now()-3e4;const{shards:t}=this;Object.keys(t).forEach((s=>{if(t[s]<e){console.log(`CLUSTER: Shard ${s} disconnected`),delete t[s];const e=this.shardOnlineCounters.findIndex((e=>e[0]===s));~e&&this.shardOnlineCounters.splice(e,1),this.subscriber.unsubscribe(s)}})),this.publisher.publish(v,this.thisShard),e-=3e4,this.csReq=this.csReq.filter((t=>t.ts>e))}}:new I;class U{static async getChunk(e,t,s,r=null){const o=`ch:${e}:${t}:${s}`;let i=await p.get((0,n.commandOptions)({returnBuffers:!0}),o);if(r>0&&i&&i.length<r){const e=Buffer.alloc(r-i.length);i=Buffer.concat([i,e])}return i}static async setChunk(e,t,s,r){const n=`ch:${r}:${e}:${t}`;return await p.set(n,Buffer.from(s.buffer)),O.broadcastChunkUpdate(r,[e,t]),!0}static async delChunk(e,t,s){const r=`ch:${s}:${e}:${t}`;return await p.del(r),O.broadcastChunkUpdate(s,[e,t]),!0}multi=null;static enqueuePixel(e,t,s,r,n){U.multi||(U.multi=p.multi(),setTimeout(U.flushPixels,100)),U.multi.addCommand(["BITFIELD",`ch:${e}:${s}:${r}`,"SET","u8",`#${n}`,String(t)])}static flushPixels(){if(U.multi){const{multi:e}=U;return U.multi=null,e.exec(!0)}return null}static async getPixelIfExists(e,t,s,r){const n=["BITFIELD",`ch:${e}:${t}:${s}`,"GET","u8",`#${r}`],o=await p.sendCommand(n);return o?o[0]:null}static async getPixelByOffset(e,t,s,r){const n=U.getPixelIfExists(e,t,s,r);return null==n?0:n}static async getPixel(e,t,s,r,n=null){const[o,i]=function(e,t,s,r=null){const n=null===r?w:32,o=null==r?s:r;return[Math.floor((t+e/2)/n),Math.floor((o+e/2)/n)]}(t,s,r,n),a=function(e,t,s,r=null){const n=null===r?w:32,o=null==r?s:r;let i=null===r?0:s*n*n;const a=$(e/2,n),c=$(t+a,n);return i+=$(o+a,n)*n+c,i}(t,s,r,n),c=U.getPixelIfExists(e,o,i,a);return null==c?0:c}}const R=U,k=class{length;rgb;colors;abgr;fl;constructor(e){this.length=e.length,this.rgb=new Uint8Array(3*this.length),this.colors=new Array(this.length),this.abgr=new Uint32Array(this.length),this.fl=new Array(this.length);let t=0;for(let s=0;s<e.length;s++){const r=e[s][0],n=e[s][1],o=e[s][2];this.rgb[t++]=r,this.rgb[t++]=n,this.rgb[t++]=o,this.colors[s]=`rgb(${r}, ${n}, ${o})`,this.abgr[s]=4278190080|o<<16|n<<8|r,this.fl[s]=[r/256,n/256,o/256]}}isDark(e){return e*=3,.2126*this.rgb[e++]+.7152*this.rgb[e++]+.0722*this.rgb[e]<128}getIndexOfColor(e,t,s){const{rgb:r}=this;let n=r.length/3;for(;n>0;){n-=1;const o=3*n;if(r[o]===e&&r[o+1]===t&&r[o+2]===s)return n}return null}getClosestIndexOfColor(e,t,s){const{rgb:r}=this;let n=r.length/3,o=0,i=null;for(;n>0;){n-=1;const a=3*n;let c=(r[a]-e)**2;c+=(r[a+1]-t)**2,c+=(r[a+2]-s)**2,(null===i||i>c)&&(o=n,i=c)}return o}};function _(e,t,s,r,n){const[o,i]=r,a=(o+i*e*s)*e,[c,l,h]=t.rgb;for(let t=0;t<e;t+=1){let r=3*(a+t*e*s);const o=r+3*e;for(;r<o;)n[r++]=c,n[r++]=l,n[r++]=h}}function x(e,t,s,r,n){const o=w,[i,a]=s,c=(i+a*t*o)*o,{rgb:l}=e,h=l[0],u=l[1],f=l[2];let d,p=0;for(let e=0;e<o;e+=1){let s=3*(c+e*o*t);const i=s+768;for(;s<i;)p<r.length?(d=3*(63&r[p++]),n[s++]=l[d++],n[s++]=l[d++],n[s++]=l[d]):(n[s++]=h,n[s++]=u,n[s++]=f)}}function D(e,t){const[s,n,o]=t,i=`${e}/${s}/${n}/${o}.webp`;try{const e=new Date(r().statSync(i).mtime).getTime();if(Date.now()-e<12e4)return null}catch{}return i}async function M(e,t,s,r,n=null){const o=n||new k(t.colors),i=t.size,[a,c]=r,l=D(s,[b(i)-1,a,c]);if(!l)return!0;const h=new Uint8Array(786432),u=Date.now(),f=2*a,d=2*c,p=[],g=async(t,s)=>{try{const r=await R.getChunk(e,f+t,d+s);if(!r||!r.length)return void p.push([t,s]);x(o,2,[t,s],r,h)}catch(r){p.push([t,s]),console.error(`Tiling: Failed to get Chunk ch:${e}:${f+t}${d+s} with error ${r.message}`)}},$=[];for(let e=0;e<2;e+=1)for(let t=0;t<2;t+=1)$.push(g(t,e));if(await Promise.all($),4!==p.length){p.forEach((e=>{_(w,o,2,e,h)}));try{await m()(h,{raw:{width:512,height:512,channels:3}}).resize(w).webp({quality:100,smartSubsample:!0}).toFile(l)}catch(e){return console.error(`Tiling: Error on createZoomTileFromChunk: ${e.message}`),!1}return console.log(`Tiling: Created Tile ${l} with ${p.length} empty chunks in ${Date.now()-u}ms`),!0}return!1}async function L(e,t,s,n=null){const o=n||new k(e.colors),i=new Uint8Array(196608),[a,c,l]=s,h=D(t,[a,c,l]);if(!h)return!0;const u=Date.now(),f=[],d=async(e,s)=>{const n=`${t}/${a+1}/${2*c+e}/${2*l+s}.webp`;try{if(!r().existsSync(n))return void f.push([e,s]);!function(e,t,s,r){const n=w,[o,i]=t,a=128*(o+i*n);let c,l=0;for(let e=0;e<128;e+=1){let t=3*(a+e*n);const o=t+384;for(;t<o;){const e=s[l++],n=s[l++],o=s[l++];l+=3,c=l+765,r[t++]=s[c++]+e>>>1,r[t++]=s[c++]+n>>>1,r[t++]=s[c]+o>>>1}l=c+1}}(0,[e,s],await m()(n).removeAlpha().raw().toBuffer(),i)}catch(t){f.push([e,s]),console.error(`Tiling: Error on createZoomedTile on chunk ${n}: ${t.message}`)}},p=[];for(let e=0;e<2;e+=1)for(let t=0;t<2;t+=1)p.push(d(t,e));if(await Promise.all(p),4!==f.length){f.forEach((e=>{_(128,o,2,e,i)}));try{await m()(i,{raw:{width:w,height:w,channels:3}}).webp({quality:100,smartSubsample:!0}).toFile(h)}catch(e){return console.error(`Tiling: Error on createZoomedTile: ${e.message}`),!1}return console.log(`Tiling: Created tile ${h} with ${f.length} empty subtiles in ${Date.now()-u}ms.`),!0}return!1}async function A(e,t,s){const n=new k(t.colors),o=t.size,i=Math.min(o,4096),a=i/w,c=2*Math.log2(a)/2,l=new Uint8Array(i*i*3),h=Date.now(),u=[],f=i!==o?async(e,t)=>{const n=`${s}/${c}/${e}/${t}.webp`;try{if(!r().existsSync(n))return void u.push([e,t]);const s=await m()(n).removeAlpha().raw().toBuffer();!function(e,t,s,r){const n=w,[o,i]=t,a=(o+i*e*n)*n;let c=0;for(let t=0;t<n;t+=1){let o=3*(a+t*n*e);const i=o+768;for(;o<i;)r[o++]=s[c++],r[o++]=s[c++],r[o++]=s[c++]}}(a,[e,t],s,l)}catch(s){u.push([e,t]),console.error(`Tiling: Error on createTexture in chunk ${n}: ${s.message}`)}}:async(t,s)=>{try{let r=null;if(r=await R.getChunk(e,t,s),!r||!r.length)return void u.push([t,s]);x(n,a,[t,s],r,l)}catch(r){u.push([t,s]),console.error(`Tiling: Failed to get Chunk ch:${e}:${t}${s} with error ${r.message}`)}},d=[];for(let e=0;e<a;e+=1)for(let t=0;t<a;t+=1)d.push(f(t,e));await Promise.all(d),u.forEach((e=>{_(w,n,a,e,l)}));const p=`${s}/texture.webp`;try{await m()(l,{raw:{width:i,height:i,channels:3}}).toFile(p)}catch(e){return void console.error(`Tiling: Error on createTexture: ${e.message}`)}console.log(`Tiling: Created texture in ${(Date.now()-h)/1e3}s.`)}if(t.isMainThread)throw new Error("Tilewriter is run as a worker thread, not as own process");(async()=>{if(console.log(`Connecting to redis server at ${l}`),await f.connect(),h&&t.isMainThread){const e=f.duplicate();await e.connect(),d.publisher=f,d.subscriber=e}})().then((()=>{t.parentPort.on("message",(async e=>{const{task:s,args:n}=e;try{switch(s){case"createZoomTileFromChunk":await M(...n);break;case"createZoomedTile":await L(...n);break;case"createTexture":await A(...n);break;case"initializeTiles":await async function(e,t,s,n=!1){console.log(`Tiling: Initializing tiles in ${s}, forceint = ${n}`);const o=Date.now(),i=new k(t.colors),a=b(t.size);await async function(e,t){const s=new Uint8Array(196608);let r=0;for(;r<196608;)s[r++]=t.rgb[0],s[r++]=t.rgb[1],s[r++]=t.rgb[2];const n=`${e}/emptytile.webp`;try{await m()(s,{raw:{width:w,height:w,channels:3}}).webp({quality:100,smartSubsample:!0}).toFile(n)}catch(e){return void console.error(`Tiling: Error on createEmptyTile: ${e.message}`)}console.log(`Tiling: Created empty tile at ${n}`)}(s,i);let c=a-1,l=`${s}/${c}`;console.log(`Tiling: Checking zoomlevel ${l}`),r().existsSync(l)||r().mkdirSync(l);let h=0,u=0;const f=2**c;for(let o=0;o<f;o+=1){const a=`${s}/${c}/${o}`;r().existsSync(a)||r().mkdirSync(a);for(let a=0;a<f;a+=1){const l=`${s}/${c}/${o}/${a}.webp`;!n&&r().existsSync(l)||(await M(e,t,s,[o,a],i)&&(u+=1),h+=1)}}for(console.log(`Tiling: Created ${u} / ${h} tiles for basezoom of canvas${e}`),c=a-2;c>=0;c-=1){h=0,u=0,l=`${s}/${c}`,console.log(`Tiling: Checking zoomlevel ${l}`),r().existsSync(l)||r().mkdirSync(l);const o=2**c;for(let e=0;e<o;e+=1){const a=`${s}/${c}/${e}`;r().existsSync(a)||r().mkdirSync(a);for(let a=0;a<o;a+=1){const o=`${s}/${c}/${e}/${a}.webp`;!n&&r().existsSync(o)||(await L(t,s,[c,e,a],i)&&(u+=1),h+=1)}}console.log(`Tiling: Created ${u} / ${h} tiles for zoom ${c} for canvas${e}`)}await A(e,t,s),console.log(`Tiling: Elapsed Time: ${Math.round((Date.now()-o)/1e3)} for canvas${e}`)}(...n);break;default:console.warn(`Tiling: Main thread requested unknown task ${s}`)}t.parentPort.postMessage("Done!")}catch(e){console.warn(`Tiling: Error on executing task ${s} args ${n}: ${e.message}`),t.parentPort.postMessage("Failure!")}}))}))})();